<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#800020">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Banda 2025">

  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <title>Sistema de Cobro - Banda Escolar</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 10px;
      background-color: #fdf2f2;
      color: #333;
      -webkit-text-size-adjust: 100%;
      line-height: 1.5;
    }
    h1 {
      text-align: center;
      color: #722f37;
      font-size: 1.4em;
      margin-bottom: 15px;
      padding: 10px;
      background-color: #800020;
      color: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .container {
      max-width: 100%;
      margin: 0 auto;
    }
    .controls {
      margin-bottom: 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    button {
      padding: 10px;
      font-size: 1em;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      min-width: 40px;
    }
    button span {
      font-size: 0.9em;
    }
    #add-btn { background-color: #1976d2; }
    #report-global-btn { background-color: #00897b; }
    #backup-btn { background-color: #5d4037; }
    #restore-btn { background-color: #558b2f; }
    #whatsapp-btn { background-color: #2e7d32; }
    .report-btn {
      background-color: #43a047;
      color: white;
      padding: 6px 8px;
      font-size: 0.9em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.95em;
      display: block;
      overflow-x: auto;
      white-space: nowrap;
    }
    th, td {
      border: 1px solid #d46f82;
      padding: 10px 6px;
      text-align: center;
    }
    th {
      background-color: #800020;
      color: white;
    }
    tr:nth-child(even) {
      background-color: #f8e6e9;
    }
    tr.hermanito {
      background-color: #ffebee !important;
      color: #c62828;
      font-style: italic;
    }
    tr.pagototal {
      background-color: #e8f5e9 !important;
      color: #2e7d32;
    }
    .nombre-cell {
      cursor: pointer;
      user-select: none;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      overflow: auto;
    }
    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      border-bottom: 2px solid #800020;
      padding-bottom: 10px;
    }
    .modal-title {
      font-size: 1.4em;
      color: #800020;
      margin: 0;
    }
    .close-modal {
      font-size: 1.5em;
      font-weight: bold;
      cursor: pointer;
      color: #c62828;
    }
    .modal-body {
      margin: 15px 0;
    }
    .field-group {
      margin: 10px 0;
    }
    .field-group label {
      display: block;
      font-weight: bold;
      color: #555;
      margin-bottom: 5px;
    }
    .field-group input, .field-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .month-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
      gap: 8px;
      margin: 10px 0;
    }
    .month-grid label {
      font-weight: normal;
      font-size: 0.8em;
      color: #444;
    }
    .month-grid input {
      width: 100%;
      padding: 6px;
      font-size: 0.9em;
    }
    .modal-footer {
      text-align: right;
      margin-top: 20px;
    }
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .btn-edit {
      background-color: #43a047;
      color: white;
    }
    .btn-delete {
      background-color: #c62828;
      color: white;
    }
    .btn-cancel {
      background-color: #9e9e9e;
      color: white;
    }
    .report-global-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .report-global-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .report-global-content table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .report-global-content th, .report-global-content td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    .report-global-content th {
      background-color: #800020;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Sistema de Cobro - Banda Escolar "Padre Rafael Arnaiz" 2025</h1>

    <!-- Filtros y controles -->
    <div class="controls">
      <button id="add-btn" title="Agregar"><i>‚ûï</i><span>Agregar</span></button>
      <button id="report-global-btn" title="Informe"><i>üìä</i><span>Informe</span></button>
      <button id="backup-btn" title="Respaldar"><i>üíæ</i><span>Respaldar</span></button>
      <button id="restore-btn" title="Restaurar"><i>üìÇ</i><span>Restaurar</span></button>
      <button id="whatsapp-btn" title="WhatsApp"><i>üì§</i><span>WhatsApp</span></button>
      <select id="filter-curso">
        <option value="">Curso</option>
        <option>1B</option><option>2A</option><option>2B</option>
        <option>3A</option><option>3B</option>
        <option>4A</option><option>4B</option>
        <option>5A</option><option>5B</option>
        <option>6A</option><option>6B</option>
      </select>
      <select id="filter-instrumento">
        <option value="">Instrumento</option>
        <option>TAMBOR</option>
        <option>ATABAL</option>
        <option>BOMBO</option>
        <option>CUADRATON</option>
        <option>LIRA</option>
        <option>TROMPETA</option>
        <option>BAR√çTONO</option>
        <option>PLATILLOS</option>
        <option>GUARIPOLERO</option>
        <option>BANDEROLAS</option>
      </select>
      <input type="text" id="search-input" placeholder="üîç Buscar..." style="width: 120px; padding: 8px;">
      <input type="file" id="restore-file" accept=".json" style="display:none">
    </div>

    <!-- Tabla principal -->
    <table id="payment-table">
      <thead>
        <tr>
          <th></th>
          <th>Nombre</th>
          <th>Curso</th>
          <th>Instrumento</th>
          <th class="month-cell">Abr</th>
          <th class="month-cell">May</th>
          <th class="month-cell">Jun</th>
          <th class="month-cell">Jul</th>
          <th class="month-cell">Ago</th>
          <th class="month-cell">Sep</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>

    <!-- Modal de edici√≥n y reporte -->
    <div class="modal" id="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="modal-title">Ficha del Estudiante</h2>
          <span class="close-modal" id="close-modal">&times;</span>
        </div>
        <div class="modal-body">
          <input type="hidden" id="modal-index">
          <div class="field-group">
            <label>Nombre</label>
            <input type="text" id="modal-nombre">
          </div>
          <div class="field-group">
            <label>Curso</label>
            <input type="text" id="modal-curso">
          </div>
          <div class="field-group">
            <label>Instrumento</label>
            <select id="modal-instrumento"></select>
          </div>
          <h4>Pagos Mensuales</h4>
          <div class="month-grid" id="month-fields"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-cancel" id="modal-cancel">‚úñ Cancelar</button>
          <button class="btn btn-delete" id="modal-delete">üóëÔ∏è Eliminar</button>
          <button class="btn btn-edit" id="modal-save">üíæ Guardar</button>
        </div>
      </div>
    </div>

    <!-- Informe Econ√≥mico Detallado -->
    <div class="report-global-modal" id="report-global-modal">
      <div class="report-global-content">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
          <h3>Informe Econ√≥mico Mensual</h3>
          <span class="close-modal" id="close-report-global">&times;</span>
        </div>
        <p><strong>Valor mensual:</strong> 25 Bs</p>
        <table id="report-table">
          <thead>
            <tr>
              <th>Mes</th>
              <th>Pagados</th>
              <th>Total (Bs)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <p><strong>Total General:</strong> <span id="total-general">0 Bs</span></p>
      </div>
    </div>
  </div>

  <script>
    const meses = ["abril", "mayo", "junio", "julio", "agosto", "septiembre"];
    const montoMensual = 25;

    const instrumentos = [
      "TAMBOR", "ATABAL", "BOMBO", "CUADRATON", "LIRA",
      "TROMPETA", "BAR√çTONO", "PLATILLOS", "GUARIPOLERO", "BANDEROLAS"
    ];

    let estudiantes = JSON.parse(localStorage.getItem("estudiantes")) || [
  {
    "nombre": "BECCAR GOMEZ ANDRICK THOMAS",
    "curso": "2B",
    "instrumento": "TAMBOR",
    "abril": "Hermanito",
    "mayo": "",
    "junio": "",
    "julio": "",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "GUTIERREZ RUIZ LUCAS SANTINO",
    "curso": "3B",
    "instrumento": "TAMBOR",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "25",
    "septiembre": ""
  },
  {
    "nombre": "MERIDA SILES JHOJAN NAHUEL",
    "curso": "3B",
    "instrumento": "TAMBOR",
    "abril": "Hermanito",
    "mayo": "",
    "junio": "",
    "julio": "",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "MERIDA JIMENEZ BRANDON SANTIAGO",
    "curso": "4A",
    "instrumento": "TAMBOR",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "SUAREZ DIAZ GAEL ADRIAN",
    "curso": "4A",
    "instrumento": "ATABAL",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "25",
    "septiembre": ""
  },
  {
    "nombre": "CARTAGENA ROCHA SANTIAGO AMILKAR",
    "curso": "4B",
    "instrumento": "ATABAL",
    "abril": "-",
    "mayo": "-",
    "junio": "25",
    "julio": "25",
    "agosto": "25",
    "septiembre": ""
  },
  {
    "nombre": "CASPA USTARIZ MATIAS ADRIEL",
    "curso": "4B",
    "instrumento": "BOMBO",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "25",
    "septiembre": ""
  },
  {
    "nombre": "FERNANDEZ BALANZA THIAGO ANDRE",
    "curso": "5A",
    "instrumento": "ATABAL",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "VASQUEZ HUARACHI ADELE VALENTINA",
    "curso": "5A",
    "instrumento": "TAMBOR",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "AYALA QUIROZ JHORDAN ESTIBEN",
    "curso": "5B",
    "instrumento": "TAMBOR",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "CLAPEZ BALANZA SOFIA VALENTINA",
    "curso": "5B",
    "instrumento": "ATABAL",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "CUSICANQUI CUEVAS JOSEPH JEREMY",
    "curso": "5B",
    "instrumento": "TAMBOR",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "FLORES GUZMAN RAUL JESSER",
    "curso": "5B",
    "instrumento": "PLATILLOS",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "QUISPE ROJAS IAN MATIAS",
    "curso": "5B",
    "instrumento": "GUARIPOLERO",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "URQUIZA MEJIA LUCAS SANTIAGO",
    "curso": "5B",
    "instrumento": "GUARIPOLERO",
    "abril": "",
    "mayo": "",
    "junio": "",
    "julio": "",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "CAMPOS CAHUANA RENE ERNESTO",
    "curso": "6A",
    "instrumento": "TAMBOR",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "25",
    "septiembre": ""
  },
  {
    "nombre": "GALARZA FERNANDEZ DANIEL",
    "curso": "6A",
    "instrumento": "CUADRATON",
    "abril": "",
    "mayo": "",
    "junio": "",
    "julio": "",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "JORGE RUIZ SAMUEL",
    "curso": "6A",
    "instrumento": "TAMBOR",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "LOZA MORALES CARLOS GABRIEL",
    "curso": "6A",
    "instrumento": "CUADRATON",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "MERIDA SILES ALEXANDER GAE",
    "curso": "6A",
    "instrumento": "TAMBOR",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "SOTO LUNARIO VALERY SAMANTA",
    "curso": "1B",
    "instrumento": "LIRA",
    "abril": "Hermanito",
    "mayo": "",
    "junio": "",
    "julio": "",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "CONDO LAFUENTE CARLA ALEJANDRA",
    "curso": "2A",
    "instrumento": "LIRA",
    "abril": "Hermanito",
    "mayo": "",
    "junio": "",
    "julio": "",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "LIMACHI AMBROCIO NADIA JHAQUELIN",
    "curso": "3A",
    "instrumento": "LIRA",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "25",
    "septiembre": ""
  },
  {
    "nombre": "LOZA MORALES AYLIN",
    "curso": "3A",
    "instrumento": "LIRA",
    "abril": "Hermanito",
    "mayo": "",
    "junio": "",
    "julio": "",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "MELGAREJO AGUIRRE ANTONELLA ZOE",
    "curso": "3B",
    "instrumento": "LIRA",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "BECCAR GOMEZ ALENA MARGARITA",
    "curso": "4A",
    "instrumento": "LIRA",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "BUTRON VARGAS BRIANNA JHURIEL",
    "curso": "4A",
    "instrumento": "LIRA",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "CARPIO PADILLA ZOE ABIMELETH",
    "curso": "4A",
    "instrumento": "LIRA",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "25",
    "septiembre": "25"
  },
  {
    "nombre": "GARCIA COLQUE ANTONELLA ESTRELLA",
    "curso": "4A",
    "instrumento": "LIRA",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "25",
    "septiembre": ""
  },
  {
    "nombre": "MEDRANO AGUILAR ARIADNA ALEJANDRA",
    "curso": "4A",
    "instrumento": "LIRA",
    "abril": "25",
    "mayo": "",
    "junio": "",
    "julio": "",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "LOPEZ FELIPEZ ISABELLA SABRINA",
    "curso": "4B",
    "instrumento": "LIRA",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "25",
    "septiembre": ""
  },
  {
    "nombre": "MERCADO GOMEZ MEGAN YARIANA",
    "curso": "4B",
    "instrumento": "LIRA",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "Espinoza Mart√≠nez Valentina N.",
    "curso": "5A",
    "instrumento": "LIRA",
    "abril": "",
    "mayo": "",
    "junio": "",
    "julio": "",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "GARCIA ALAVI ARELIZ NARELLA",
    "curso": "5A",
    "instrumento": "LIRA",
    "abril": "",
    "mayo": "",
    "junio": "",
    "julio": "",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "GUTIERREZ CHOQUEVILLCA ABIGAIL E.",
    "curso": "5A",
    "instrumento": "LIRA",
    "abril": "25",
    "mayo": "",
    "junio": "25",
    "julio": "25",
    "agosto": "25",
    "septiembre": ""
  },
  {
    "nombre": "PINTO MITA KENIA ARELIZ",
    "curso": "5A",
    "instrumento": "LIRA",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "QUIROGA CORTEZ STEPHANYE NICOLE",
    "curso": "5A",
    "instrumento": "LIRA",
    "abril": "25",
    "mayo": "25",
    "junio": "",
    "julio": "",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "MAMANI DIAZ GABRIELA GISEL",
    "curso": "5B",
    "instrumento": "LIRA",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "25",
    "septiembre": ""
  },
  {
    "nombre": "BUSTAMANTE CABRERA LUCIANA G.",
    "curso": "6A",
    "instrumento": "LIRA",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "GONZALES MANRRIQUE ANA VALENTINA",
    "curso": "6A",
    "instrumento": "LIRA",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "25",
    "septiembre": ""
  },
  {
    "nombre": "OMONTE MAMANI BRITANI AYLIN",
    "curso": "6A",
    "instrumento": "LIRA",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "25",
    "septiembre": ""
  },
  {
    "nombre": "OPORTO CARRILLO JADE JACKELINE",
    "curso": "6A",
    "instrumento": "LIRA",
    "abril": "",
    "mayo": "",
    "junio": "",
    "julio": "",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "PADILLA SANCHEZ ASHLEY NICOL",
    "curso": "6A",
    "instrumento": "LIRA",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "25",
    "septiembre": ""
  },
  {
    "nombre": "SOTO LUNARIO MAYTE NICOLE",
    "curso": "6A",
    "instrumento": "LIRA",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "25",
    "septiembre": ""
  },
  {
    "nombre": "FUENTES SALAZAR GHINA CAMILA",
    "curso": "6B",
    "instrumento": "LIRA",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "LOPEZ ROJAS CRISTEL JULIA",
    "curso": "6B",
    "instrumento": "LIRA",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "25",
    "septiembre": ""
  },
  {
    "nombre": "PADILLA COCA KATERINE SHEYLA",
    "curso": "6B",
    "instrumento": "LIRA",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "25",
    "septiembre": ""
  },
  {
    "nombre": "COLQUE MONTA√ëO ANDRES SEBASTIAN",
    "curso": "3A",
    "instrumento": "TROMPETA",
    "abril": "Hermanito",
    "mayo": "",
    "junio": "",
    "julio": "",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "GONZALES MANRRIQUE GADIEL ALEX",
    "curso": "3A",
    "instrumento": "TROMPETA",
    "abril": "Hermanito",
    "mayo": "",
    "junio": "",
    "julio": "",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "FUENTES GALLEGO SANTIAGO IKENI",
    "curso": "3B",
    "instrumento": "TROMPETA",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "25",
    "septiembre": ""
  },
  {
    "nombre": "FLORES BRAVO JHEFERSON MATEO",
    "curso": "4A",
    "instrumento": "BAR√çTONO",
    "abril": "25",
    "mayo": "",
    "junio": "",
    "julio": "",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "LOZADA CUEVAS JOSHUA GERARDO",
    "curso": "4A",
    "instrumento": "TROMPETA",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "QUISPE ZOTAR BENJAMIN",
    "curso": "4B",
    "instrumento": "TROMPETA",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "25",
    "septiembre": ""
  },
  {
    "nombre": "COLQUE MONTA√ëO JOHAVI JOSE",
    "curso": "5B",
    "instrumento": "BAR√çTONO",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "25",
    "septiembre": ""
  },
  {
    "nombre": "CONDO LAFUENTE PEDRO LEONARDO",
    "curso": "5B",
    "instrumento": "TROMPETA",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "BLANCO HEREDIA NICOLAS YAIR",
    "curso": "6A",
    "instrumento": "TROMPETA",
    "abril": "25",
    "mayo": "25",
    "junio": "25",
    "julio": "25",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "ALCOCER VILLARROEL EMMANUEL",
    "curso": "3A",
    "instrumento": "TROMPETA",
    "abril": "-",
    "mayo": "-",
    "junio": "",
    "julio": "",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "UVINA JIMENEZ CRISTIAN",
    "curso": "4A",
    "instrumento": "TROMPETA",
    "abril": "-",
    "mayo": "-",
    "junio": "25",
    "julio": "",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "Beltr√°n Monta√±o Jhajaira B.",
    "curso": "5A",
    "instrumento": "BANDEROLAS",
    "abril": "-",
    "mayo": "-",
    "junio": "-",
    "julio": "25",
    "agosto": "25",
    "septiembre": ""
  },
  {
    "nombre": "Huanca Rocha Aneth",
    "curso": "5A",
    "instrumento": "BANDEROLAS",
    "abril": "-",
    "mayo": "-",
    "junio": "-",
    "julio": "25",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "Ticona Cuellar Madelin N.",
    "curso": "5A",
    "instrumento": "BANDEROLAS",
    "abril": "-",
    "mayo": "-",
    "junio": "-",
    "julio": "",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "Su√°rez D√≠az Lia A.",
    "curso": "5B",
    "instrumento": "BANDEROLAS",
    "abril": "-",
    "mayo": "-",
    "junio": "-",
    "julio": "25",
    "agosto": "25",
    "septiembre": ""
  },
  {
    "nombre": "Moya Pinto Violeta C.",
    "curso": "6A",
    "instrumento": "BANDEROLAS",
    "abril": "-",
    "mayo": "-",
    "junio": "-",
    "julio": "25",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "Carpio Padilla Amanda M.",
    "curso": "6B",
    "instrumento": "BANDEROLAS",
    "abril": "-",
    "mayo": "-",
    "junio": "-",
    "julio": "25",
    "agosto": "25",
    "septiembre": "25"
  },
  {
    "nombre": "Camacho Claros Nicol A.",
    "curso": "6B",
    "instrumento": "BANDEROLAS",
    "abril": "-",
    "mayo": "-",
    "junio": "-",
    "julio": "",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "Vedia Jorge Oriana",
    "curso": "6B",
    "instrumento": "BANDEROLAS",
    "abril": "-",
    "mayo": "-",
    "junio": "-",
    "julio": "",
    "agosto": "",
    "septiembre": ""
  },
  {
    "nombre": "Lopez Vargas Ainhoa Evangeline",
    "curso": "4B",
    "instrumento": "LIRA",
    "abril": "25",
    "mayo": "25",
    "junio": "-",
    "julio": "-",
    "agosto": "-",
    "septiembre": "-"
  },
  {
    "nombre": "Padilla Mariscal Nicole Gabriela",
    "curso": "4B",
    "instrumento": "LIRA",
    "abril": "25",
    "mayo": "-",
    "junio": "-",
    "julio": "-",
    "agosto": "-",
    "septiembre": "-"
  },
  {
    "nombre": "Moron Omente Sebastian Alfredo",
    "curso": "6A",
    "instrumento": "TROMPETA",
    "abril": "25",
    "mayo": "-",
    "junio": "-",
    "julio": "-",
    "agosto": "-",
    "septiembre": "-"
  }
];

    estudiantes.forEach(est => {
      meses.forEach(mes => {
        if (est[mes] === undefined) est[mes] = "";
      });
    });

    const tableBody = document.getElementById("table-body");
    const searchInput = document.getElementById("search-input");
    const filterCurso = document.getElementById("filter-curso");
    const filterInstrumento = document.getElementById("filter-instrumento");
    const addBtn = document.getElementById("add-btn");
    const reportGlobalBtn = document.getElementById("report-global-btn");
    const backupBtn = document.getElementById("backup-btn");
    const restoreBtn = document.getElementById("restore-btn");
    const restoreFile = document.getElementById("restore-file");
    const whatsappBtn = document.getElementById("whatsapp-btn");

    const modal = document.getElementById("modal");
    const modalTitle = document.getElementById("modal-title");
    const modalIndex = document.getElementById("modal-index");
    const modalNombre = document.getElementById("modal-nombre");
    const modalCurso = document.getElementById("modal-curso");
    const modalInstrumento = document.getElementById("modal-instrumento");
    const monthFields = document.getElementById("month-fields");
    const closeModal = document.getElementById("close-modal");
    const modalCancel = document.getElementById("modal-cancel");
    const modalSave = document.getElementById("modal-save");
    const modalDelete = document.getElementById("modal-delete");

    const reportGlobalModal = document.getElementById("report-global-modal");
    const closeReportGlobal = document.getElementById("close-report-global");
    const reportTableBody = document.getElementById("report-table").querySelector("tbody");
    const totalGeneral = document.getElementById("total-general");

    // Llenar select de instrumentos
    instrumentos.forEach(inst => {
      const opt = document.createElement("option");
      opt.value = inst;
      opt.textContent = inst;
      modalInstrumento.appendChild(opt);
    });

    function saveData() {
      localStorage.setItem("estudiantes", JSON.stringify(estudiantes));
    }

    function isHermanito(val) {
      return typeof val === 'string' && val.toLowerCase().trim() === 'hermanito';
    }

    function haCompletadoTodosLosMeses(estudiante) {
      return meses.every(mes => {
        const val = estudiante[mes];
        return val && (val === "25" || val === "-" || isHermanito(val));
      });
    }

    function renderTable(data = estudiantes) {
      tableBody.innerHTML = "";
      data.forEach((estudiante, visualIndex) => {
        const realIndex = estudiantes.findIndex(e => e === estudiante);
        const bloqueado = meses.some(mes => isHermanito(estudiante[mes]));
        const completado = haCompletadoTodosLosMeses(estudiante);
        const rowClass = bloqueado ? 'hermanito' : (completado ? 'pagototal' : '');
        const row = document.createElement("tr");
        if (rowClass) row.classList.add(...rowClass.split(' '));

        let mesCells = '';
        meses.forEach(mes => {
          const val = estudiante[mes] || '';
          mesCells += `<td class="month-cell">${val}</td>`;
        });

        row.innerHTML = `
          <td><button class="report-btn" onclick="openModal(${realIndex})">üìã</button></td>
          <td class="nombre-cell">${estudiante.nombre}</td>
          <td>${estudiante.curso}</td>
          <td>${estudiante.instrumento}</td>
          ${mesCells}
        `;

        row.querySelector(".nombre-cell").onclick = () => openModal(realIndex);
        tableBody.appendChild(row);
      });
    }

    function openModal(realIndex) {
      if (realIndex < 0 || realIndex >= estudiantes.length) return;
      const est = estudiantes[realIndex];

      modalIndex.value = realIndex;
      modalNombre.value = est.nombre;
      modalCurso.value = est.curso;
      modalInstrumento.value = est.instrumento;

      monthFields.innerHTML = '';
      meses.forEach(mes => {
        const val = est[mes] || '';
        const isH = isHermanito(val);
        const div = document.createElement("div");
        div.innerHTML = `
          <label>${mes.slice(0,3).toUpperCase()}</label>
          <input type="text" data-mes="${mes}" value="${val}"
            ${isH ? 'readonly style="background:#ffebee;color:#c62828;"' : ''}>
        `;
        monthFields.appendChild(div);
      });

      modal.style.display = "block";
    }

    // Cerrar modales
    [closeModal, modalCancel, modal].forEach(el => {
      if (el === modal) {
        el.onclick = e => { if (e.target === modal) modal.style.display = "none"; };
      } else {
        el.onclick = () => modal.style.display = "none";
      }
    });

    closeReportGlobal.onclick = () => reportGlobalModal.style.display = "none";
    reportGlobalModal.onclick = e => { if (e.target === reportGlobalModal) reportGlobalModal.style.display = "none"; };

    // Guardar cambios
    modalSave.addEventListener("click", () => {
      const realIndex = parseInt(modalIndex.value);
      if (realIndex < 0 || realIndex >= estudiantes.length) return;

      const updated = {
        nombre: modalNombre.value.trim(),
        curso: modalCurso.value.trim(),
        instrumento: modalInstrumento.value
      };

      meses.forEach(mes => {
        const input = monthFields.querySelector(`[data-mes="${mes}"]`);
        updated[mes] = input.value.trim();
      });

      Object.assign(estudiantes[realIndex], updated);
      saveData();
      renderTable(applyFilters());
      modal.style.display = "none";
    });

    // Eliminar
    modalDelete.addEventListener("click", () => {
      const realIndex = parseInt(modalIndex.value);
      if (realIndex < 0 || realIndex >= estudiantes.length) return;
      if (confirm(`¬øEliminar a ${estudiantes[realIndex].nombre}?`)) {
        estudiantes.splice(realIndex, 1);
        saveData();
        renderTable(applyFilters());
        modal.style.display = "none";
      }
    });

    // Filtros
    function applyFilters() {
      const curso = filterCurso.value;
      const instrumento = filterInstrumento.value;
      const search = searchInput.value.toLowerCase();
      return estudiantes.filter(est => {
        return (curso === '' || est.curso === curso) &&
               (instrumento === '' || est.instrumento === instrumento) &&
               (est.nombre.toLowerCase().includes(search));
      });
    }

    searchInput.addEventListener("input", () => renderTable(applyFilters()));
    filterCurso.addEventListener("change", () => renderTable(applyFilters()));
    filterInstrumento.addEventListener("change", () => renderTable(applyFilters()));

    // Agregar
    addBtn.addEventListener("click", () => {
      const nombre = prompt("Nombre:");
      if (!nombre) return;
      const curso = prompt("Curso:");
      const instrumento = prompt("Instrumento:\n" + instrumentos.join("\n"));
      if (!instrumento || !instrumentos.includes(instrumento.toUpperCase())) {
        alert("Instrumento no v√°lido.");
        return;
      }
      const nuevo = { nombre, curso, instrumento };
      meses.forEach(mes => nuevo[mes] = "");
      estudiantes.push(nuevo);
      saveData();
      renderTable(applyFilters());
    });

    // Informe detallado
    reportGlobalBtn.addEventListener("click", () => {
      reportTableBody.innerHTML = "";
      let totalGeneralBs = 0;

      meses.forEach(mes => {
        let count = 0;
        estudiantes.forEach(est => {
          const val = est[mes];
          if (val && val !== "-" && !isHermanito(val) && !isNaN(val) && parseFloat(val) > 0) {
            count++;
          }
        });
        const totalMes = count * montoMensual;
        totalGeneralBs += totalMes;

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${mes.charAt(0).toUpperCase() + mes.slice(1)}</td>
          <td>${count}</td>
          <td>${totalMes} Bs</td>
        `;
        reportTableBody.appendChild(row);
      });

      totalGeneral.textContent = `${totalGeneralBs} Bs`;
      reportGlobalModal.style.display = "block";
    });

    // Respaldar
    backupBtn.addEventListener("click", () => {
      const dataStr = JSON.stringify(estudiantes, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `respaldo_banda_2025_${new Date().toISOString().split("T")[0]}.json`;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
      alert("‚úÖ Respaldo descargado.");
    });

    // Restaurar
    restoreBtn.addEventListener("click", () => {
      restoreFile.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = JSON.parse(e.target.result);
            if (Array.isArray(data)) {
              data.forEach(est => {
                meses.forEach(mes => {
                  if (est[mes] === undefined) est[mes] = "";
                });
              });
              if (confirm(`¬øRestaurar ${data.length} registros?`)) {
                estudiantes = data;
                saveData();
                renderTable(applyFilters());
                alert("‚úÖ Datos restaurados.");
              }
            } else {
              throw new Error("Formato inv√°lido");
            }
          } catch (err) {
            alert("‚ùå Error: archivo no v√°lido.");
          }
        };
        reader.readAsText(file);
      };
      restoreFile.click();
    });

    // WhatsApp
    whatsappBtn.addEventListener("click", () => {
      const telefono = "59168450136";
      const mensaje = encodeURIComponent("Hola, aqu√≠ est√° el respaldo del sistema de cobro de la Banda Escolar.");
      const whatsappUrl = `https://wa.me/${telefono}?text=${mensaje}`;
      if (confirm("Se abrir√° WhatsApp. ¬øContinuar?")) {
        setTimeout(() => window.open(whatsappUrl, '_blank'), 500);
      }
    });

    // Inicializar
    renderTable();

    // Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => console.log('SW registrado'))
          .catch(err => console.log('Error SW:', err));
      });
    }
  </script>
</body>

</html>
